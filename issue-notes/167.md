# issue PR 164（issue 163 に紐付くPR）がcloseされたときに、これまでと違ってPR 163が自動closeされず、userが手動でissue 163をcloseした。なぜ自動closeされなかったか分析する #167
[issues #167](https://github.com/cat2151/ym2151-log-play-server/issues/167)

## 分析結果

### 根本原因

GitHubのissue自動クローズ機能は、**PRがマージされたとき**にのみ動作し、**PRが単にクローズされたとき**には動作しません。

### GitHubの自動クローズ機能の仕組み

GitHubは以下のキーワードをPR説明文またはコミットメッセージで検出すると、PRがマージされた際に自動的にissueをクローズします：

- `close`, `closes`, `closed`
- `fix`, `fixes`, `fixed`
- `resolve`, `resolves`, `resolved`

**重要な条件：**
1. これらのキーワードは**PR説明文**または**コミットメッセージ**に含まれている必要があります
2. 自動クローズは**PRがマージされたとき**のみ実行されます
3. PRが単にクローズされた（マージされずに閉じられた）場合、issueは開いたままになります
4. デフォルトブランチ（`main`または`master`）へのマージのみが対象です

### PR 164とissue 163のケース

issue 163は、`build_windows.yml`ワークフローによってCI/CDテスト失敗時に自動生成されたissueです。

PR 164がissue 163を自動クローズしなかった理由は以下のいずれかです：

1. **PR 164がマージされずにクローズされた**
   - PRが単にクローズされた場合、自動クローズは発動しません
   - これが最も可能性の高い原因です

2. **PR 164の説明文またはコミットメッセージに適切なキーワードがなかった**
   - `closes #163`、`fixes #163`、`resolves #163`のような記述が含まれていなかった可能性
   - キーワードがあっても形式が不適切だった可能性（例：「fix issue 163」は動作しない）

3. **リポジトリ設定で自動クローズが無効化されている**
   - リポジトリの設定で「Auto-close issues with merged linked pull requests」が無効になっている可能性
   - ただし、「これまでと違って」という記述から、この可能性は低いです

### 推奨される対応策

今後同様の問題を避けるために：

1. **PRをマージする際の確認事項：**
   - PRがissueを解決する場合、マージする前にクローズせず、必ずマージ操作を使用する
   - PR説明文に `closes #<issue番号>` または `fixes #<issue番号>` を必ず含める

2. **PR作成時のベストプラクティス：**
   - PR説明文のテンプレートを作成し、関連issueへの参照を含めるようにする
   - 例：「This PR fixes #163」

3. **ワークフロー改善案：**
   - PR作成時に自動的に適切なキーワードを含むテンプレートを使用する
   - PRレビュー時に、関連issueへの適切な参照があるかチェックする

4. **リポジトリ設定の確認：**
   - Settings → Issues で「Auto-close issues with merged linked pull requests」が有効になっているか確認

### 参考資料

- [GitHub Docs: Using keywords in issues and pull requests](https://docs.github.com/en/get-started/writing-on-github/working-with-advanced-formatting/using-keywords-in-issues-and-pull-requests)
- [GitHub Docs: Linking a pull request to an issue](https://docs.github.com/articles/closing-issues-via-commit-messages)
- [GitHub Docs: Managing the automatic closing of issues](https://docs.github.com/en/repositories/managing-your-repositorys-settings-and-features/managing-repository-settings/managing-auto-closing-issues)

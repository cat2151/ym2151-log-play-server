# issue issue 102 の「JSONフォーマットを f64 seconds に統一する」に実装漏れと実装誤りがあり、codeとtest codeがビルドエラー #110
[issues #110](https://github.com/cat2151/ym2151-log-play-server/issues/110)

# 補足
- [issues #113](https://github.com/cat2151/ym2151-log-play-server/issues/113) MMCSS対応も、実装誤りと実装漏れでビルドエラーになっていた
  - それは切り分けて対処した。詳しくは後述を参照。
- さらに、
  - test用のJSON時間指定を55930で割る作業が漏れていた
    - agentのハルシネーションによる考慮漏れ
    - 後述で対処させた
  - agentにlocal Windowsで作業させたら、
    - 55930でハードコードしていたようなので、
      - それも定数を使うように修正させた
# 修正計画
- 以下をloacal Windowsのagentに投げた
  - 結果、若干userのオーダーミスはあったが、概ねOK
    - オーダーミスは都度修正して指示した
```
# f64秒フォーマット 対応漏れ 修正計画

## 概要
Issue #102: JSONフォーマットをf64秒に統一する実装計画 について対応漏れがあった

## 現状分析

### 既に実装済み
- `events.rs`: f64秒での時刻フィールド（`time: f64`）
- `player.rs`: f64秒からサンプル単位への変換
- `output_ym2151_f64seconds.json`: f64秒形式のテストファイル

### 問題点
- mmcss対応実装がバグっており、ビルド/実行に影響している
- 実装code、test code、実装のなかのコメントtest codeに、以下の対応漏れがある
  - sample単位の記述の残留
    - JSONのtimeの記述において、30以上の整数値はすべて、sample単位で書かれている
      - これは「対応漏れ」である
      - 正しくはこう：
        - それを55930.0で割り算した、秒単位、に修正がマスト
        - 例、
          - 2000 sample の値なら、0.035 などの値に修正がマスト
          - 55930という数値リテラルのハードコードは回避し、かわりにOPM_SAMPLE_RATE という定数を使うこと
  - 注意事項
    - JSONと異なり、wave generator最内周処理では、scheduled time はf64でなくsamples単位である
    - これは変更しないこと
    - これは型を追っていけばわかるはず

## 実装戦略

1. mmcss関連コードを一時的にコメントアウト
   - `src/mmcss.rs`の使用箇所を無効化
   - ビルドエラーを解消
    - ただし、上記の「対応漏れ」によるビルドエラーもあるため、
      - 2.も並列で行う形になる
2. 上記の「対応漏れ」を修正
3. ビルドエラーの可視化

## 要注意
- 既存機能を破壊しないこと
  - 現在projectが巨大なためagentがハルシネーションして、
    - 「コメントアウト」「削除」などをやりがち
      - 結果的にソース破壊につながる
    - 今回コメントアウトしていいのはmmcssだけ！
```
# 結果
- OK

# 原因分析
- GitHub Copilot Coding Agent が、GitHub上の Linux Runner でしか動かないため
  - そこでのagentのTDDは、
    - Linux用feature（Windows用featureなし）となるため
  - この要素はWindows用の要素であるため、
    - agentがハルシネーションしたところを、
      - 検知して修正する手段、
        - がなかった
- 対策案
  - GitHub Copilot Coding Agent が、GitHub上の Linux Runner で動く際に、
    - agentがハルシネーションしたとき、
      - それを検知して修正する手段を
        - 調査する
          - 別のissueにて切り分けて実施する

# closeとする

# issue client側のdemo interactive modeでserverとの接続を失敗することがあり、かつ再現したりしなかったりする #116
[issues #116](https://github.com/cat2151/ym2151-log-play-server/issues/116)

# 問題の本質
- サーバーはシングルスレッドで実装されており、
    - 1つの接続を処理中は
        - 次の接続を受け入れられない。
    - 前の接続が切断されてから
        - 新しいパイプインスタンスを作成して接続待機状態になるまでの
            - 時間的ギャップで、
                - クライアントの接続が失敗する。
    - インタラクティブモードで短時間の間に大量接続すると、
        - 接続失敗し、エラーとなる可能性がある
            - なぜなら、クライアントにリトライのシステムが実装されていない
# 選択肢
- 名前付きパイプ、シングルスレッド、アトミックに接続
    - メリット
        - シンプル
        - 複数クライアントからの接続に耐えうる。アトミックなので。
            - 接続したらすぐ切断、なので。
    - デメリット
        - 速度が遅い
        - 再接続時に、間に合わずにエラーがありうる。
            - リトライのシステムがマスト
        - 検証してどれくらいでも大丈夫かを見るといいだろう
- 名前付きパイプ、シングルスレッド、セッション占有
    - メリット
        - 高速
            - gptによると1ms未満もありうる
        - ややシンプル
    - デメリット
        - やや複雑
            - セッション開始、セッション中の送受信、セッション終了、
                - が必要
        - 複数クライアントからの接続はできず、2つめのクライアントがエラーになる
            - なので「複数アプリからの同時利用」ができない
                - なんか、そういう用途は少なそうな気はする
                    - 検証したほうがいいだろう
- 名前付きパイプ、マルチスレッド
    - メリット
        - いいとこどり
            - 複数クライアントからの接続ができつつ、
            - それぞれがセッションを個別に持てるから、
                - 高速
    - デメリット
        - 複雑
            - audioをmutexにしないといけないらしい
        - 用途にマッチしてない可能性
            - 用途として、「さらにリアルタイムで高頻度のメッセージ受信」
                - がありうる
            - その用途なら、共有メモリにしたほうがいい可能性がある
- 共有メモリ
    - 複雑なので、後回し
        - 用途としては十分ありうる
            - リアルタイムで高頻度のメッセージ送信によるシーケンス
                - 例、ディレイビブラート
            - server内部stateのビジュアライズ
# 前提知識
- Windows名前付きパイプは、
    - 仮想化されたメモリストリームなので、物理ストレージの制約はない
    - 処理時間のボトルネックは、セッションopen/closeの時間
        - セッション開きっぱなしだと速い
    - マルチセッション可
# 選んだこと
- 方針、シンプル、小さく始める
- 選んだもの
    - 「名前付きパイプ、シングルスレッド、アトミックに接続」
- 結果
    - OK
# close条件
- エラーにならないこと
    - 備忘、ヨレたりモタったりは仕組み上、あって当然
        - 原因
            - client側で、演奏時刻0.0のjsonしか作ってない
                - （client時計による時刻スケジューリングjsonを作っていない）
        - これは別issueで対処とする
# closeとする

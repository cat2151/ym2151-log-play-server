name: Windows CI

on:
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry/index
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry/cache
          key: ${{ runner.os }}-cargo-deps-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache target directory
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Build code
        run: cargo build --locked --verbose

      - name: Install cargo-nextest
        uses: taiki-e/install-action@nextest

      - name: Run tests with nextest
        id: test
        timeout-minutes: 15
        continue-on-error: true
        run: |
          cargo nextest run 2>&1 | Tee-Object -FilePath test_output.log
          exit $LASTEXITCODE

      - name: Parse test results from JUnit XML
        if: always() && (steps.test.outcome == 'failure' || steps.test.outcome == 'cancelled' || steps.test.outcome == 'timed_out')
        id: test_summary
        shell: pwsh
        run: |
          $junitFile = "target/nextest/default/junit.xml"
          
          if (Test-Path $junitFile) {
            python3 .github/scripts/parse_nextest_junit.py --junit-file "$junitFile" --github-output $env:GITHUB_OUTPUT
            if ($LASTEXITCODE -ne 0) {
              Write-Error "Failed to parse JUnit XML file"
              exit 1
            }
          } else {
            # Create temporary files for fallback case
            $failedTestsListFile = [System.IO.Path]::GetTempFileName()
            $errorDetailsFile = [System.IO.Path]::GetTempFileName()
            
            "JUnit XMLファイルが見つかりませんでした" | Out-File -FilePath $failedTestsListFile -Encoding utf8
            "JUnit XMLファイルが見つかりませんでした" | Out-File -FilePath $errorDetailsFile -Encoding utf8
            
            "total_tests=不明" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            "passed=不明" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            "failed=不明" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            "timed_out=不明" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            "failed_tests_list_file=$failedTestsListFile" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            "error_details_file=$errorDetailsFile" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          }



      - name: Upload test log artifacts
        if: always() && (steps.test.outcome == 'failure' || steps.test.outcome == 'cancelled' || steps.test.outcome == 'timed_out')
        uses: actions/upload-artifact@v4
        with:
          name: test-logs
          path: |
            test_output.log
            target/nextest/default/junit.xml
          retention-days: 30

      - name: Determine failure status
        if: always() && (steps.test.outcome == 'failure' || steps.test.outcome == 'cancelled' || steps.test.outcome == 'timed_out')
        id: failure_status
        shell: pwsh
        run: |
          if ("${{ steps.test.outcome }}" -eq "cancelled" -or "${{ steps.test.outcome }}" -eq "timed_out") {
            "status_en=timed out" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            "status_ja=タイムアウトによりキャンセル" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          } else {
            "status_en=failed" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            "status_ja=失敗" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          }

      # IMPORTANT: Gemini API translation is REQUIRED for generating issue bodies.
      # If the GEMINI_API_KEY secret is not set or the API call fails, this step MUST fail.
      # Fallback behavior (skipping translation) is strictly forbidden.
      # This ensures configuration or API issues are immediately visible.
      - name: Generate issue body
        if: always() && (steps.test.outcome == 'failure' || steps.test.outcome == 'cancelled' || steps.test.outcome == 'timed_out')
        id: issue_body
        shell: pwsh
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          # Force Python to use UTF-8 encoding to handle Unicode (emoji, Japanese text) on Windows
          PYTHONIOENCODING: utf-8
        run: |
          $issueBody = python3 .github/scripts/generate_test_failure_issue.py `
            --status-ja "${{ steps.failure_status.outputs.status_ja }}" `
            --total-tests "${{ steps.test_summary.outputs.total_tests }}" `
            --passed "${{ steps.test_summary.outputs.passed }}" `
            --failed "${{ steps.test_summary.outputs.failed }}" `
            --timed-out "${{ steps.test_summary.outputs.timed_out }}" `
            --failed-tests-list-file "${{ steps.test_summary.outputs.failed_tests_list_file }}" `
            --error-details-file "${{ steps.test_summary.outputs.error_details_file }}" `
            --workflow "${{ github.workflow }}" `
            --job "${{ github.job }}" `
            --run-id "${{ github.run_id }}" `
            --run-attempt "${{ github.run_attempt }}" `
            --ref "${{ github.ref }}" `
            --commit "${{ github.sha }}" `
            --server-url "${{ github.server_url }}" `
            --repository "${{ github.repository }}"
          
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Failed to generate issue body"
            exit 1
          }
          
          "body<<EOF" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          $issueBody | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "EOF" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Create issue on failure
        if: always() && (steps.test.outcome == 'failure' || steps.test.outcome == 'cancelled' || steps.test.outcome == 'timed_out')
        uses: dacbd/create-issue-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "test ${{ steps.failure_status.outputs.status_en }}"
          body: ${{ steps.issue_body.outputs.body }}
          labels: "ci,windows,auto-generated"

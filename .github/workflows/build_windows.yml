name: Windows CI

on:
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry/index
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry/cache
          key: ${{ runner.os }}-cargo-deps-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache target directory
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Build code
        run: cargo build --locked --verbose

      - name: Install cargo-nextest
        uses: taiki-e/install-action@nextest

      - name: Run tests with nextest
        id: test
        timeout-minutes: 15
        continue-on-error: true
        run: |
          # nextest: 設定ファイル(.config/nextest.toml)でタイムアウト、fail-fast、failure-outputを設定済み
          cargo nextest run 2>&1 | Tee-Object -FilePath test_output.log
          exit $LASTEXITCODE

      - name: Capture test failure summary
        if: always() && (steps.test.outcome == 'failure' || steps.test.outcome == 'cancelled')
        id: test_output
        shell: pwsh
        run: |
          # GitHub issue用にログを取得（最大65000文字）
          if (Test-Path test_output.log) {
            $content = Get-Content -Path test_output.log -Raw -ErrorAction SilentlyContinue
            if ($content -and $content.Length -gt 65000) {
              $content = $content.Substring($content.Length - 65000)
            }
            if ($content) {
              "log<<EOF" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
              $content | Out-File -FilePath $env:GITHUB_OUTPUT -Append
              "EOF" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            }
          }

      - name: Upload test log artifacts
        if: always() && (steps.test.outcome == 'failure' || steps.test.outcome == 'cancelled')
        uses: actions/upload-artifact@v4
        with:
          name: test-logs
          path: test_output.log
          retention-days: 30

      - name: Determine failure status
        if: always() && (steps.test.outcome == 'failure' || steps.test.outcome == 'cancelled')
        id: failure_status
        shell: pwsh
        run: |
          if ("${{ steps.test.outcome }}" -eq "cancelled") {
            "status_en=timed out" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            "status_ja=タイムアウトによりキャンセル" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          } else {
            "status_en=failed" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            "status_ja=失敗" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          }

      - name: Create issue on failure
        if: always() && (steps.test.outcome == 'failure' || steps.test.outcome == 'cancelled')
        uses: dacbd/create-issue-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "[CI] Windows build or test ${{ steps.failure_status.outputs.status_en }}"
          body: |
            Windows CI でビルドまたはテストに失敗しました。

            **ステータス**: ${{ steps.failure_status.outputs.status_ja }}

            ## ログへのリンク
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ## 詳細
            - Workflow: ${{ github.workflow }}
            - Job: ${{ github.job }}
            - Run ID: ${{ github.run_id }}
            - Run Attempt: ${{ github.run_attempt }}
            - Ref: ${{ github.ref }}
            - Commit: ${{ github.sha }}

            ## テスト失敗サマリー
            <details>
            <summary>クリックして展開</summary>

            ```
            ${{ steps.test_output.outputs.log }}
            ```

            </details>

            ## アーティファクト
            完全なログは上記リンクの「Artifacts」セクションから `test-logs` をダウンロードしてください。
          labels: "ci,windows,auto-generated"
